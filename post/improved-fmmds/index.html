<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.6.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=author content="Ananth Mahadevan"><meta name=description content="A faster implementation of the FMMD (Fair Max-Min Diversification) algorithm"><link rel=alternate hreflang=en-us href=http://www.ananthmahadevan.com/post/improved-fmmds/><meta name=theme-color content="#1565c0"><script src=/js/mathjax-config.js></script>
<link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin=anonymous media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script>
<link rel=stylesheet href=/css/wowchemy.3495fc6150afdd177f1d04fbba9f5e2c.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu83a2933a4b16038170999f1c101a10c2_11917_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu83a2933a4b16038170999f1c101a10c2_11917_180x180_fill_lanczos_center_3.png><link rel=canonical href=http://www.ananthmahadevan.com/post/improved-fmmds/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@Mahadea96"><meta property="twitter:creator" content="@Mahadea96"><meta property="og:site_name" content="Ananth Mahadevan"><meta property="og:url" content="http://www.ananthmahadevan.com/post/improved-fmmds/"><meta property="og:title" content="Scaling Up Constraint-Based Diverse Sampling | Ananth Mahadevan"><meta property="og:description" content="A faster implementation of the FMMD (Fair Max-Min Diversification) algorithm"><meta property="og:image" content="http://www.ananthmahadevan.com/post/improved-fmmds/featured.png"><meta property="twitter:image" content="http://www.ananthmahadevan.com/post/improved-fmmds/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-02-12T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-22T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.ananthmahadevan.com/post/improved-fmmds/"},"headline":"Scaling Up Constraint-Based Diverse Sampling","image":["http://www.ananthmahadevan.com/post/improved-fmmds/featured.png"],"datePublished":"2024-02-12T00:00:00Z","dateModified":"2024-08-22T00:00:00Z","author":{"@type":"Person","name":"Ananth Mahadevan"},"publisher":{"@type":"Organization","name":"Ananth Mahadevan","logo":{"@type":"ImageObject","url":"http://www.ananthmahadevan.com/media/icon_hu83a2933a4b16038170999f1c101a10c2_11917_192x192_fill_lanczos_center_3.png"}},"description":"A faster implementation of the FMMD (Fair Max-Min Diversification) algorithm"}</script><title>Scaling Up Constraint-Based Diverse Sampling | Ananth Mahadevan</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=68a5017f15df2b6116951916e2cf5c34><script src=/js/wowchemy-init.min.613040fe4f2c0f007b4dcb64404201cb.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Ananth Mahadevan</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Ananth Mahadevan</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class="nav-link active" href=/post/><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/publication/><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/uploads/Resume.pdf><span>CV</span></a></li><li class=nav-item><a class=nav-link href=/project/><span>Projects</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Scaling Up Constraint-Based Diverse Sampling</h1><p class=page-subtitle>A faster implementation of the FMMD (Fair Max-Min Diversification) algorithm</p><div class=article-metadata><div><span class=author-highlighted>Ananth Mahadevan</span></div><span class=article-date>Last updated on
Aug 22, 2024</span>
<span class=middot-divider></span>
<span class=article-reading-time>8 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/scaling-up/>Scaling up</a></span></div><div class="btn-links mb-3"><a class="btn btn-outline-primary btn-page-header" href=/project/hpc-hd/>Project</a>
<a class="btn btn-outline-primary btn-page-header" href=https://github.com/ananth1996/improved-fmmds target=_blank rel=noopener><i class="fab fa-github mr-1"></i>Code</a></div></div><div class="article-header container featured-image-wrapper mt-4 mb-4" style=max-width:1033px;max-height:393px><div style=position:relative><img src=/post/improved-fmmds/featured_hu7529f4db59353344289e2f4c8788b590_61482_1200x2500_fit_q75_h2_lanczos_3.webp width=1033 height=393 alt class=featured-image>
<span class=article-header-caption>Speedup compared to original implementation</span></div></div><div class=article-container><div class=article-style><h1 id=improved-fmmd-s>Improved FMMD-S</h1><p>An improved implementation of the FMMD-S algorithm from the paper:</p><blockquote><p>Wang, Y., Mathioudakis, M., Li, J., & Fabbri, F. (2023). Max-Min Diversification with Fairness Constraints: Exact and Approximation Algorithms. In Proceedings of the 2023 SIAM International Conference on Data Mining (SDM) (pp. 91–99). Society for Industrial and Applied Mathematics. <a href=https://doi.org/10.1137/1.9781611977653.ch11 target=_blank rel=noopener>https://doi.org/10.1137/1.9781611977653.ch11</a></p></blockquote><h2 id=table-of-contents>Table of Contents</h2><ul><li><a href=#improved-fmmd-s>Improved FMMD-S</a><ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#algorithm-overview>Algorithm Overview</a></li><li><a href=#setup>Setup</a><ul><li><a href=#python>Python</a></li><li><a href=#gurobi>Gurobi</a></li><li><a href=#cython>Cython</a></li></ul></li><li><a href=#balanced-sampling>Balanced Sampling</a><ul><li><a href=#old-fmmd-s-implementation-bottlenecks>Old FMMD-S implementation Bottlenecks</a></li></ul></li><li><a href=#speedup-over-original-implementation>Speedup over original Implementation</a></li><li><a href=#when-to-parallelize>When to parallelize?</a></li><li><a href=#full-experiment-results>Full Experiment Results</a></li><li><a href=#limitations-and-future-updates>Limitations and Future Updates</a></li></ul></li></ul><h2 id=algorithm-overview>Algorithm Overview</h2><p>The FMMD-S algorithm described in the paper has the following four steps:</p><ol><li>Obtain a greedy solution with <code>k</code> items using the Gonzales algorithm without regard for group constraints</li><li>For each group run the Gonzales algorithm to obtain a coreset and a diversity threshold</li><li>Creates a coreset graph where edges signify the distance between items are lower than the diversity threshold</li><li>Create the MIS problem using the coreset graph and solve using ILP solver</li><li>If solution is infeasible decrease diversity threshold and go to step 2, else return solution</li></ol><p>The FMMD-S algorithm is available in <a href=https://github.com/ananth1996/improved-fmmds/blob/main/fmmd/algorithms.py target=_blank rel=noopener>fmmd.algorithms</a> is the <code>fmmd</code> function</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>fmmd</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>features</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ids</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>groups</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>constraints</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>    <span class=n>eps</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>time_limit</span><span class=p>:</span><span class=nb>int</span> <span class=o>=</span> <span class=mi>300</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=p>:</span><span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>parallel_dist_update</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>parallel_edge_creation</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>set</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;The implementation of the Fair Max-Min Diversification algorithm.
</span></span></span><span class=line><span class=cl><span class=s2>    First obtains a greedy solution ignoring fairness constrains. Then obtains a coreset by 
</span></span></span><span class=line><span class=cl><span class=s2>    getting greedy solutions in each group. Solves the MIS problem on the coreset.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        features (np.ndarray): The feature vectors of the items 
</span></span></span><span class=line><span class=cl><span class=s2>        ids (np.ndarray): The ids of the items  
</span></span></span><span class=line><span class=cl><span class=s2>        groups (np.ndarray): The group (int) of the items
</span></span></span><span class=line><span class=cl><span class=s2>        k (int): The minimum number of total samples required
</span></span></span><span class=line><span class=cl><span class=s2>        constraints (List[Tuple[int,int]]): The list of lower and upper limits on number of samples for each group 
</span></span></span><span class=line><span class=cl><span class=s2>        eps (float): The fraction to relax the diversity to get a solution.
</span></span></span><span class=line><span class=cl><span class=s2>        time_limit (int): The maximum number of seconds for Gurobi solver
</span></span></span><span class=line><span class=cl><span class=s2>        verbose (bool, optional): Print many debug statements. Defaults to False.
</span></span></span><span class=line><span class=cl><span class=s2>        parallel_dist_update (bool, optional): Whether to update distances in parallel. Defaults to False.
</span></span></span><span class=line><span class=cl><span class=s2>        parallel_edge_creation (bool, optional): Whether to create coreset graph edges in parallel. Defaults to False.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        Tuple[set,float]: Returns the solution as set of item ids and the solution diversity
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id=setup>Setup</h2><h3 id=python>Python</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>conda env create -n fmmd -f env.yaml
</span></span></code></pre></div><h3 id=gurobi>Gurobi</h3><p>The FMMD-S algorithm uses <a href=https://www.gurobi.com target=_blank rel=noopener>Gurobi</a> to solve the MIS problem as explained in the paper.</p><p>The gurobi optimizer can be used without a license for small datasets, but for larger datasets it is recommended to have an <a href=https://www.gurobi.com/academia/academic-program-and-licenses/ target=_blank rel=noopener>academic licence</a>.</p><h3 id=cython>Cython</h3><p>This library uses Cython to compile and parallelize several utility functions.</p><p>Run the following command to build the module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python setup.py build_ext --inplace
</span></span></code></pre></div><p>After building, the module is used like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fmmd.parallel_utils</span> <span class=n>pdist</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span><span class=mi>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=n>pdist</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span></code></pre></div><p>The <code>.pyx</code> is found in <a href=https://github.com/ananth1996/improved-fmmds/blob/main/cython/parallel_utils.pyx target=_blank rel=noopener>ctython/parallel_utils.pyx</a> and can be modified to add additional metrics and functionalities.</p><h2 id=balanced-sampling>Balanced Sampling</h2><p>This library was developed specifically to perform balanced sampling.</p><p>Balanced sampling is when there is a need to uniformly sample from groups instead of the typical proportional
sampling. Specifically, we wanted to perform balanced sampling when the distribution of groups was very skewed. This means that there are some groups with very few items and some groups with a lot of items. Furthermore, if <code>min_group_size</code> is the size of the smallest group and <code>k>min_group_size</code> then we might be forced to take all items from smaller groups.</p><p>For example, assume we have the following group sizes:</p><table><thead><tr><th style=text-align:right>group</th><th style=text-align:right>count</th></tr></thead><tbody><tr><td style=text-align:right>1</td><td style=text-align:right>2</td></tr><tr><td style=text-align:right>2</td><td style=text-align:right>5</td></tr><tr><td style=text-align:right>3</td><td style=text-align:right>10</td></tr><tr><td style=text-align:right>4</td><td style=text-align:right>200</td></tr></tbody></table><p>Now, if we want to sample at least ten items uniformly <code>k>=10</code> then, we would need to select all items from group 1 and 3 items from the remaining groups. This would result in <code>k=11</code> items where we take a maximum of <code>3</code> from each group. This is what the <code>find_num_samples_per_group</code> method in the <a href=https://github.com/ananth1996/improved-fmmds/blob/main/datasets/naive_balanced_sampling.py target=_blank rel=noopener>datasets/naive_balanced_sampling.py</a> does. It returns <code>num_samples_per_group,total_number_of_samples</code> for a given group distribution and minimum number of samples.</p><h3 id=old-fmmd-s-implementation-bottlenecks>Old FMMD-S implementation Bottlenecks</h3><p>This sort of balanced sampling constraints causes several bottlenecks in the original FMMD-S implementation:</p><ol><li>When entire groups need to be selected, the diversity threshold is relaxed several times until the constraints is not <code>under_capped</code></li><li>The coreset graph typically is much larger as several groups are added directly. This results in a long time to compute the edges which satisfy the diversity constraints</li><li>When the ILP is infeasible steps 1 and 2 need to performed again</li></ol><p>We fix these issues in the new implementations. Along with these fixes, a parallelization of several portions of the algorithm offer a general speedup compared the original implementation.</p><h2 id=speedup-over-original-implementation>Speedup over original Implementation</h2><p>Running the benchmark on the Census dataset from the original paper.
For the full census dataset. <code>k</code> is the number of samples and <code>C</code> is the number of groups.</p><p>New and improved algorithm implementation</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python census_single_solution.py -k<span class=o>=</span><span class=m>10</span> -C<span class=o>=</span><span class=m>2</span>
</span></span></code></pre></div><p>Original algorithm implementation</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python census_single_solution.py -k<span class=o>=</span><span class=m>10</span> -C<span class=o>=</span><span class=m>2</span> --old
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>k</th><th style=text-align:right>C</th><th style=text-align:right>Original (in seconds)</th><th style=text-align:right>New (in seconds)</th><th style=text-align:right>Relative Speedup</th></tr></thead><tbody><tr><td style=text-align:left>10</td><td style=text-align:right>2</td><td style=text-align:right>112.67</td><td style=text-align:right>8.316</td><td style=text-align:right>13.55x</td></tr><tr><td style=text-align:left>10</td><td style=text-align:right>7</td><td style=text-align:right>106.24</td><td style=text-align:right>8.256</td><td style=text-align:right>12.87x</td></tr><tr><td style=text-align:left>50</td><td style=text-align:right>14</td><td style=text-align:right>474.152</td><td style=text-align:right>10.503</td><td style=text-align:right>45.14x</td></tr><tr><td style=text-align:left>100</td><td style=text-align:right>14</td><td style=text-align:right>3670.781</td><td style=text-align:right>18.092</td><td style=text-align:right>202.90x</td></tr></tbody></table><p>Experiments on an Apple MacBook Pro with a M2 Pro chip and 16GB RAM.</p><h2 id=when-to-parallelize>When to parallelize?</h2><p>The <code>gonzales_algorithm</code> method found in <a href=https://github.com/ananth1996/improved-fmmds/blob/main/fmmd/algorithms.py target=_blank rel=noopener>fmmd/algorithms.py</a> has the argument <code>parallel_dist_update</code>. This argument will parallelize the update to the distance array. The <code>gonzales_algoritm</code> is used in both step 1 and step 2 (see <a href=#algorithm-overview>Algorithm Overview</a>) and can offer substantial speedups.</p><p>Therefore, to test the speed-up of one execution of the Gonzales algorithm, we executed the following for different number of items and feature dimensions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>default_rng</span><span class=p>(</span><span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>features</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ids</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>gonzales_algorithm</span><span class=p>(</span><span class=nb>set</span><span class=p>(),</span><span class=n>features</span><span class=p>,</span><span class=n>ids</span><span class=p>,</span><span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span><span class=n>parallel_dist_update</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=c1># with parallel </span>
</span></span><span class=line><span class=cl><span class=n>gonzales_algorithm</span><span class=p>(</span><span class=nb>set</span><span class=p>(),</span><span class=n>features</span><span class=p>,</span><span class=n>ids</span><span class=p>,</span><span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span><span class=n>parallel_dist_update</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=c1># with parallel </span>
</span></span></code></pre></div><p>The result for speed up is shown in the figure below:</p><p align=center><img src=./parallel_dist_update_speedup.png alt=edges_speedup width=500></p><p>All blue regions are where the parallel version is slower than the sequential version and all the red regions are where the parallel regions are faster than the sequential versions.</p><p>Similarly, the <code>get_coreset_graph</code> method in in <a href=https://github.com/ananth1996/improved-fmmds/blob/main/fmmd/algorithms.py target=_blank rel=noopener>fmmd/algorithms.py</a> has an argument <code>parallel_edges_creation</code>. This option uses the <code>fmmd.parallel_utils.edges</code> method to parallelize step 3 of the algorithm as described in <a href=#algorithm-overview>Algorithm Overview</a>. Again, the speed-up depends on the number of items in the coreset and the dimensionality of each item.</p><p>Therefore, to test the speed-up offered by the parallel version, we run the following two methods with random data of different coreset size and dimensions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>default_rng</span><span class=p>(</span><span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>features</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>parallel_utils</span><span class=o>.</span><span class=n>edges</span><span class=p>(</span><span class=n>features</span><span class=p>,</span><span class=mf>0.01</span><span class=p>)</span> <span class=c1># parallel edge creation</span>
</span></span><span class=line><span class=cl><span class=n>parallel_utils</span><span class=o>.</span><span class=n>edges_sequential</span><span class=p>(</span><span class=n>features</span><span class=p>,</span><span class=mf>0.01</span><span class=p>)</span> <span class=c1># sequential edge creation</span>
</span></span></code></pre></div><p>The results are shown below:</p><p align=center><img src=./parallel_edges_speedup.png alt=edges_speedup width=500></p>All blue regions are where the parallel version is slower than the sequential version and all the red regions are where the parallel regions are faster than the sequential versions.<blockquote><p>The number of coreset items depends on the data features, the number of samples <code>k</code> and the constraints for the FMMD problem.</p></blockquote><p>As discussed above, the parallel options are only useful when the number of dimensions increase.
Therefore, using the full <code>768</code> dimensional embeddings for the ECCO dataset, we select <code>k=500</code> balanced samples as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python ecco_balanced_samples.py -k<span class=o>=</span><span class=m>500</span>  --eps<span class=o>=</span>0.5
</span></span></code></pre></div><p>The <code>fmmd</code> method found in <a href=https://github.com/ananth1996/improved-fmmds/blob/main/fmmd/algorithms.py target=_blank rel=noopener>fmmd/algorithms.py</a> has two options to utilize multiple cores:</p><ol><li><code>--parallel-dist-update</code>: Update the solution distances in parallel for the Gonzales algorithm</li><li><code>--parallel-edge-creation</code>: Find the coreset edges in parallel which are below the diversity threshold</li></ol><p>For the ECCO dataset and balanced sampling we observe the following trends:</p><table><thead><tr><th style=text-align:center><code>--parallel-dist-update</code></th><th style=text-align:center><code>--parallel-edge-creation</code></th><th style=text-align:right>Running Time</th><th style=text-align:right>Relative Speedup</th></tr></thead><tbody><tr><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:right>4444.224</td><td style=text-align:right>4.55</td></tr><tr><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:right>1781.913</td><td style=text-align:right>1.82</td></tr><tr><td style=text-align:center>❌</td><td style=text-align:center>✅</td><td style=text-align:right>3625.860</td><td style=text-align:right>3.71</td></tr><tr><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:right>976.961</td><td style=text-align:right>1.00</td></tr></tbody></table><p>The above ablation results indicate the majority of the speedup is gained from the parallel updates and that the speedup from parallel edge creation is relatively smaller potentially due to the number of coreset items.</p><h2 id=full-experiment-results>Full Experiment Results</h2><p>For the ECCO dataset, there are 4.2 million items and 137 groups with a very skewed distribution. The requirement was at least 3000 balanced samples. With the group distribution resulted in the following:</p><ol><li>Maximum of <code>26</code> samples from each group</li><li><code>3063</code> total samples</li></ol><p>The items are <code>768</code> dimensional embedding which take 3min to load the 22GB vectors.</p><p>The FFMD-S solution takes 9250.9 seconds (2.5hrs).</p><p>The FMMD-S algorithm has the following stages:</p><ol><li>Finding an initial greedy solution without thinking of buckets: <strong>1615.6 sec</strong></li><li>Finding a core-set of the data from buckets starting from the initial samples : <strong>1832.83 sec</strong></li><li>Computing pair-wise distances and selecting ones which are below a diversity threshold: <strong>5779.5 sec</strong></li><li>Creating a coreset graph with nodes from 2 and edges from 3: <strong>0.69 sec</strong></li><li>Solving an Integer Linear Program of a coreset from 4 to get final solution: <strong>17.27 sec</strong></li></ol><p>All these times are on a system with 40 cores and 80GB RAM (of which only 25GB was actually used)
The main bottleneck as seen is step 3. This is because we end up with 274,398 items in the coreset leading to the computation of nearly 37B pair-wise distances. After step 3 we only have 253 edges below the required threshold, so the rest of the algorithm is very quick.</p><h2 id=limitations-and-future-updates>Limitations and Future Updates</h2><p>There are some limitations compared to the original implementations. These will be addressed as the need arises.</p><ol><li>Only supports L2 distance metric</li><li>No ability to generate multiple solutions in parallel to obtain the best overall diversity</li></ol></div><div class=article-tags><a class="badge badge-light" href=/tag/academic/>Academic</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=http://www.ananthmahadevan.com/post/improved-fmmds/&amp;text=Scaling%20Up%20Constraint-Based%20Diverse%20Sampling" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=http://www.ananthmahadevan.com/post/improved-fmmds/&amp;t=Scaling%20Up%20Constraint-Based%20Diverse%20Sampling" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Scaling%20Up%20Constraint-Based%20Diverse%20Sampling&amp;body=http://www.ananthmahadevan.com/post/improved-fmmds/" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=http://www.ananthmahadevan.com/post/improved-fmmds/&amp;title=Scaling%20Up%20Constraint-Based%20Diverse%20Sampling" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Scaling%20Up%20Constraint-Based%20Diverse%20Sampling%20http://www.ananthmahadevan.com/post/improved-fmmds/" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=http://www.ananthmahadevan.com/post/improved-fmmds/&amp;title=Scaling%20Up%20Constraint-Based%20Diverse%20Sampling" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=http://www.ananthmahadevan.com><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_hue3ffad70859443acdc3141988d65886b_206625_270x270_fill_q75_lanczos_center.jpeg alt="Ananth Mahadevan"></a><div class=media-body><h5 class=card-title><a href=http://www.ananthmahadevan.com>Ananth Mahadevan</a></h5><h6 class=card-subtitle>Machine Learning PhD Student</h6><p class=card-text>My research interests include systems for Machine Learning and network science.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:ananth.mahadevan@helsinki.fi><i class="fas fa-envelope"></i></a></li><li><a href="https://scholar.google.com/citations?hl=en&amp;user=z-LNyRsAAAAJ" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://github.com/ananth1996 target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://www.linkedin.com/in/ananth-mahadevan-75411651/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=/uploads/Resume.pdf><i class="ai ai-cv"></i></a></li></ul></div></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2024 Ananth Mahadevan. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.32ee83730ed883becad04bc5170512cc.js></script>
<script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.c251366b4128fd5e6b046d4c97a62a51.js type=module></script>
<script src=/en/js/wowchemy.min.85290d887e7fcdd400ccb3ffb9bcd3e3.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>